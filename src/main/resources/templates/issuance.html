<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"> <!-- Added Thymeleaf namespace -->
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CIS</title>
    <style>
      /* --- Common Styles (like verify.html) --- */
      body {
        font-family: "Lucida Sans", "Lucida Sans Regular", "Lucida Grande",
          "Lucida Sans Unicode", Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f4f4f4;
      }
      .header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 20px;
        border-bottom: 1px solid #ccc;
        margin-bottom: 30px;
      }
      .header-container h3 {
        margin: 0;
        font-size: x-large; /* Keep original font size */
      }
      .nav-links {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .nav-links a {
        text-decoration: none;
        color: #333;
        font-weight: bold;
        padding: 5px 10px;
        border-radius: 4px;
        transition: background-color 0.3s ease;
        font-size: large; /* Keep original font size */
      }
      .nav-links a:hover {
        background-color: #eee;
      }

      /* --- Content Area Styles (like verify.html) --- */
      .content-container {
        display: flex;
        justify-content: center;
        align-items: flex-start; /* Align box to the top */
      }
      .issuance-box { /* Renamed from verification-box */
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
        width: 600px; /* Adjusted width for content */
        max-width: 90%;
        text-align: center; /* Center heading and button initially */
      }
      .issuance-box h3 {
        margin-top: 0;
        margin-bottom: 20px;
        color: #d9534f; /* Match verify.html style */
        text-align: center;
      }

      /* --- Specific Issuance Styles --- */
      .font-bold { /* Kept for elements needing bold */
        font-weight: bold;
      }
      .submitButton {
        background-color: #4caf50;
        color: white;
        padding: 14px 20px;
        margin: 20px 0 8px 0; /* Added top margin */
        border: none;
        border-radius: 4px;
        cursor: pointer;
        width: auto; /* Don't force full width */
        min-width: 150px; /* Give it some minimum width */
        font-size: 16px;
        transition: background-color 0.3s ease;
      }
      .submitButton:hover {
         background-color: #45a049;
      }

      .resetButton {
        background-color:rgb(233, 26, 26);
        color: white;
        padding: 14px 20px;
        margin: 20px 0 8px 0; /* Added top margin */
        border: none;
        border-radius: 4px;
        cursor: pointer;
        width: auto; /* Don't force full width */
        min-width: 150px; /* Give it some minimum width */
        font-size: 16px;
        transition: background-color 0.3s ease;
      }
      .resetButton:hover { /* Changed from .submitButton to .resetButton */
         background-color: rgb(233, 26, 26); /* Updated hover color */
      }

      #divResponse p,
      #divResponse div {
        margin-top: 10px;
        margin-bottom: 10px;
        word-break: break-all;
        text-align: left; /* Align response text left */
      }
      #divResponse {
         margin-top: 20px;
         padding: 15px;
         border: 1px solid #ddd;
         border-radius: 4px;
         background-color: #f9f9f9;
         display: none; /* Initially hidden */
      }
      .error-message {
        color: red;
        font-weight: bold;
      }
      #divAcceptOfferVC {
         margin-top: 20px;
         text-align: left; /* Align offer details left */
         border-top: 1px solid #eee; /* Add separator */
         padding-top: 20px; /* Add space above offer */
      }
       #span_offer_url, #tx_code {
         background-color: #eee;
         padding: 8px;
         border-radius: 4px;
         display: block; /* Make them block elements */
         margin-top: 5px;
         word-break: break-all;
       }
       #tx_code_div {
         margin-top: 15px;
       }
       #divAcceptOfferVC .submitButton { /* Style button within offer section */
          margin-top: 15px;
       }
       .did-display p { /* Style the DID display */
          margin-bottom: 20px;
          font-size: medium;
          color: #555;
       }

      /* --- Removed Unused Styles --- */
      /* .flex-container, .font-large, .form-div */

    </style>
  </head>

  <body>
    <!-- Header remains the same -->
    <div class="header-container">
      <h3>Affinidi Reference App</h3>
      <div class="nav-links">
        <a href="/">Home</a>
        <a href="/issuance">Issuance</a>
        <a href="/iota">Iota</a>
        <a href="/verify">Verify</a>
        <!-- Thymeleaf conditional links -->
        <a th:if="${userDid != null}" href="/user">User Info</a>
        <a th:if="${userDid != null}" href="/logout">Logout</a>
      </div>
    </div>

    <!-- Updated Content Area -->
    <div class="content-container">
      <div class="issuance-box"> <!-- Use the new box style -->
        <h3>Issuing VC for Insurance Registration</h3>

        <!-- Display User DID if available -->
        <div th:if="${userDid != null}" class="did-display">
          <p>Your DID: <strong id="spnUserDid" th:text="${userDid}"></strong></p>
        </div>
        <div th:unless="${userDid != null}">
           <p class="error-message">User DID not found. Issuance will proceed without a specific user DID.</p>
        </div>

        <!-- Action Buttons/Info Area -->
        <!-- divRequestVC is kept for JS targeting, but styling is handled by issuance-box -->
        <div id="divRequestVC">
            <button class="submitButton" id="btnIssueVC">Issue VC</button>
        </div>

        <!-- Response Area -->
        <div id="divResponse">
            <!-- Status messages will appear here -->
        </div>

        <!-- Offer Display Area (Initially Hidden) -->
        <div id="divAcceptOfferVC" style="display:none;">
          <p class="font-bold">Credential Offer URL:</p>
          <div id="span_offer_url"></div> <!-- Populated by JS -->

          <div class="font-bold" id="tx_code_div" style="display: none;">
              Transaction Code:
              <div id="tx_code"></div> <!-- Populated by JS -->
          </div>

          <button
            type="button"
            role="button"
            class="submitButton"
            onclick="SaveVault_Click()"
          >
            Claim VC
          </button>
            <button
            type="button"
            role="button"
            class="resetButton"
            onclick="location.reload();"
          >
            Reset
          </button>
        </div>

      </div> <!-- End issuance-box -->
    </div> <!-- End content-container -->

  </body>
  <script>
    // Get references to elements
    const issueButton = document.getElementById("btnIssueVC");
    const requestDiv = document.getElementById("divRequestVC"); // Still needed for hiding/showing logic
    const acceptOfferDiv = document.getElementById("divAcceptOfferVC");
    const offerUrlSpan = document.getElementById("span_offer_url");
    const txCodeDiv = document.getElementById("tx_code_div");
    const txCodeSpan = document.getElementById("tx_code");
    const responseDiv = document.getElementById("divResponse"); // Reference needed for status/errors

    async function startIssuance(userDid) {
      // Clear previous results/status and hide offer section
      responseDiv.innerHTML = '';
      responseDiv.style.display = 'none';
      acceptOfferDiv.style.display = 'none';

      // Show loading state
      responseDiv.innerHTML = '<p>Requesting credential issuance...</p>';
      responseDiv.style.display = 'block';
      if (issueButton) issueButton.disabled = true;

      try {
        console.log("Sending userDid to API:", userDid);
        const response = await fetch("/api/cis-issuance", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ userDid: userDid }),
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({
            message: `HTTP error! Status: ${response.status}`,
          }));
          throw new Error(
            errorData.message ||
              `Network response was not ok (${response.status})`
          );
        }

        const result = await response.json();
        console.log("Issuance API result:", result);
        // Clear loading status on success before showing offer
        responseDiv.innerHTML = "";
        responseDiv.style.display = "none";
        return result;

      } catch (error) {
        console.error("There was a problem with the issuance fetch operation:", error);
        // Display error in the response div
        responseDiv.innerHTML = `<p class="error-message">Error starting issuance: ${error.message}</p>`;
        responseDiv.style.display = 'block'; // Ensure error is visible
        return null; // Indicate failure
      } finally {
        // Re-enable button regardless of success or failure
        // We will hide the button on success later, so disabling is enough here
        if (issueButton) issueButton.disabled = false;
      }
    }

    // Event Listener for Issue Button
    if (issueButton) {
      issueButton.addEventListener("click", async (event) => {
        event.preventDefault();

        const didElm = document.getElementById("spnUserDid");
        const userDid = didElm ? didElm.innerText.trim() : null;

        console.log("User DID found on page:", userDid);

        const response = await startIssuance(userDid);

        if (response && response.credentialOfferUri) {
          // --- Success: Hide request button area, show offer details ---
          requestDiv.style.display = "none"; // <<<--- ADD THIS LINE TO HIDE THE BUTTON'S CONTAINER
          acceptOfferDiv.style.display = "block";

          // Make offer URL a clickable link
          offerUrlSpan.innerHTML = `<a href="${response.credentialOfferUri}" target="_blank" style="word-break: break-all;">${response.credentialOfferUri}</a>`;

          // Display transaction code if present
          if (response.txCode) {
            txCodeSpan.innerText = response.txCode;
            txCodeDiv.style.display = "block";
          } else {
            txCodeDiv.style.display = "none";
          }
        } else if (response) {
          // API call succeeded but didn't return the expected URI
          responseDiv.innerHTML = `<p class="error-message">Issuance request processed, but no offer URI was returned. Response: ${JSON.stringify(response)}</p>`;
          responseDiv.style.display = 'block';
          requestDiv.style.display = 'block'; // Ensure request button area is visible on partial failure
        }
        // If response is null, the error is already shown by startIssuance
        else {
           requestDiv.style.display = 'block'; // Ensure request button area is visible on fetch failure
        }
      });
    } else {
      console.warn("Issue VC button (btnIssueVC) not found in the DOM.");
    }

    // Function for "Claim VC" Button (previously SaveVault_Click)
    function SaveVault_Click() { // Consider renaming if it's more about claiming
      const offerLinkElement = document.querySelector("#span_offer_url a");
      if (offerLinkElement && offerLinkElement.href) {
        window.open(offerLinkElement.href, "_blank").focus();
      } else {
        console.error("Offer URL link not found or is not valid.");
        responseDiv.innerHTML = `<p class="error-message">Could not find the offer URL to open.</p>`;
        responseDiv.style.display = 'block';
      }
    }
  </script>

</html>
